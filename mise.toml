[env]
RUST_LOG = "info"
RUST_BACKTRACE = "1"
KINA_CONFIG_DIR = "$HOME/.config/kina"
KINA_DATA_DIR = "$HOME/.local/share/kina"

[tools]
rust = "stable"
kubectx = "latest"
kubens = "latest"
cilium-cli = "latest"
"ubi:nushell/nushell" = { version = "0.108.0", exe = "nu" }
act = "0.2.82"
"github:steveyegge/beads" = "0.49.0"

# ============================================================================
# BUILD & DEVELOPMENT
# ============================================================================

[tasks.build]
description = "Build the kina CLI application"
run = "cargo build --release"
dir = "kina-cli"

[tasks.dev]
description = "Build in development mode"
run = "cargo build"
dir = "kina-cli"

[tasks.check]
description = "Check code without building"
run = "cargo check"
dir = "kina-cli"

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean"
dir = "kina-cli"

[tasks.install]
description = "Install kina CLI locally"
run = "cargo install --path ."
dir = "kina-cli"

[tasks."kina:install"]
description = "Install kina CLI from project root"
run = "cargo install --path kina-cli"

[tasks.fmt]
description = "Format code with rustfmt"
run = "cargo fmt"
dir = "kina-cli"

[tasks.lint]
description = "Run clippy lints"
run = "cargo clippy -- -D warnings"
dir = "kina-cli"

[tasks.docs]
description = "Generate documentation"
run = "cargo doc --open"
dir = "kina-cli"

[tasks.watch]
description = "Watch files and rebuild on changes"
run = "cargo watch -x check -x test"
dir = "kina-cli"

# ============================================================================
# TESTING
# ============================================================================

[tasks.test]
description = "Run all unit tests"
run = "cargo test"
dir = "kina-cli"

[tasks."test:cli"]
description = "Run basic CLI functionality tests"
run = [
    "cargo run --release -- --version",
    "cargo run --release -- --help",
    "cargo run --release -- create --help",
    "cargo run --release -- config show --help",
]
dir = "kina-cli"

[tasks.ci]
description = "Run CI pipeline (fmt check, clippy, test)"
run = "nu scripts/ci.nu"

[tasks."pre-commit"]
description = "Run pre-commit checks (fmt, lint, test, audit, gitleaks)"
run = "nu scripts/pre-commit.nu"

[tasks.coverage]
description = "Generate test coverage report"
run = "cargo tarpaulin --out html --output-dir coverage"
dir = "kina-cli"

[tasks.bench]
description = "Run benchmarks"
run = "cargo bench"
dir = "kina-cli"

[tasks.audit]
description = "Run security audit"
run = "cargo audit"
dir = "kina-cli"

# Integration tests

[tasks."test:cluster"]
description = "Create integration test cluster with ingress and demo app"
run = "nu scripts/test-cluster.nu"
timeout = "10m"

[tasks."test:cluster:multi"]
description = "Create multi-node integration test cluster (1 control-plane + 2 workers)"
run = "nu scripts/test-cluster-multi.nu"
timeout = "15m"

[tasks."test:cluster:validate"]
description = "Validate integration test cluster by testing the demo app"
run = "nu scripts/test-cluster-validate.nu"

[tasks."test:cluster:hosts"]
description = "Add demo cluster worker IPs to /etc/hosts for browser testing (requires sudo)"
run = "nu scripts/test-cluster-hosts.nu"

[tasks."test:cluster:hosts:clean"]
description = "Remove kina entries from /etc/hosts"
run = "KINA_HOSTS_CLEAN=1 nu scripts/test-cluster-hosts.nu"

[tasks."test:cluster:cleanup"]
description = "Clean up integration test clusters (removes demo-* clusters)"
run = "nu scripts/test-cluster-cleanup.nu"

# GitHub Actions local testing

[tasks."test:action"]
description = "Test GitHub action locally using act (pull_request workflow)"
run = "nu scripts/test-action.nu"

[tasks."test:action:pr"]
description = "Test GitHub action for pull_request workflow (with colima)"
run = "nu scripts/test-action-pr.nu"

[tasks."test:action:push"]
description = "Test GitHub action for push to main workflow"
run = "nu scripts/test-action-push.nu"

# ============================================================================
# KINA CLI
# ============================================================================

[tasks.kina]
description = "Run the kina CLI (builds if needed)"
run = 'cargo run --release -- "$@"'
dir = "kina-cli"
timeout = "5m"

[tasks."kina:dev"]
description = "Run the kina CLI in development mode (faster build)"
run = 'cargo run -- "$@"'
dir = "kina-cli"

[tasks."kina:use"]
description = "Set kubectl context to a kina cluster (auto-selects if only one running)"
usage = 'arg "[cluster]"'
run = "nu scripts/kina-use.nu"

# ============================================================================
# CONTAINER & IMAGE MANAGEMENT
# ============================================================================

[tasks."container:check"]
description = "Check Apple Container availability"
run = """
#!/usr/bin/env nu
if (which container | is-not-empty) {
    print "Apple Container CLI found"
    let v = (do { ^container --version } | complete)
    if $v.exit_code == 0 { print ($v.stdout | str trim) } else { print "Version check failed" }
} else {
    print "Apple Container CLI not found"
}
"""

[tasks."image:build"]
description = "Build custom Kubernetes node image"
run = "nu scripts/image-build.nu"

[tasks."image:list"]
description = "List available container images"
run = "container image list"

[tasks."image:test"]
description = "Test the custom node image"
run = "nu scripts/image-test.nu"

[tasks."image:validate"]
description = "Build and test the node image"
depends = ["image:build", "image:test"]

[tasks."image:clean"]
description = "Clean up unused container images"
run = "nu -c 'let r = (do { ^container image prune -f } | complete); if $r.exit_code != 0 { print \"No images to clean\" } else { print $r.stdout }'"

# ============================================================================
# KUBERNETES TOOLS
# ============================================================================

[tasks."k8s:check"]
description = "Check Kubernetes tools availability"
run = "nu scripts/k8s-check.nu"

[tasks."k8s:install"]
description = "Install Kubernetes tools via mise"
run = "mise install kubectx kubens"

# ============================================================================
# SETUP
# ============================================================================

[tasks.setup]
description = "Set up development environment"
run = [
    "rustup component add rustfmt clippy",
    "cargo install cargo-audit",
    "cargo install cargo-tarpaulin",
    "mkdir -p ${KINA_CONFIG_DIR} ${KINA_DATA_DIR}",
]

[tasks."setup:dev"]
description = "Complete development environment setup"
depends = ["setup", "k8s:install"]
run = [
    "mise run container:check",
    "mise run k8s:check",
]

[tasks.release]
description = "Build release binary"
run = [
    "mise run ci",
    "cargo build --release",
    "strip target/release/kina",
]

# ============================================================================
# SECURITY
# ============================================================================

[tasks.gitleaks]
description = "Run gitleaks secret scanner (Apple Container runtime)"
run = "nu scripts/gitleaks.nu"

[tasks."gitleaks:docker"]
description = "Run gitleaks secret scanner (Docker runtime)"
run = "nu scripts/gitleaks-docker.nu"

[tasks."gitleaks:colima"]
description = "Run gitleaks secret scanner (Colima runtime)"
run = "nu scripts/gitleaks-colima.nu"

[tasks."gitleaks:stop"]
description = "Stop all container runtimes"
run = "nu scripts/gitleaks-stop.nu"

# ============================================================================
# CI/CD TOOLS
# ============================================================================

[tasks."colima:start"]
description = "Start colima with Docker runtime (macOS only)"
run = "nu scripts/colima-start.nu"

[tasks."colima:stop"]
description = "Stop colima"
run = "nu scripts/colima-stop.nu"

# ============================================================================
# BEADS ISSUE TRACKING
# ============================================================================

[tasks."bd:ready"]
description = "Show beads tasks ready to work on (no blockers)"
run = "bd ready"

[tasks."bd:list"]
description = "List all open beads tasks"
run = "bd list"

[tasks."bd:sync"]
description = "Sync beads with git remote"
run = "bd sync"

[tasks."bd:doctor"]
description = "Check beads health and configuration"
run = "bd doctor"
