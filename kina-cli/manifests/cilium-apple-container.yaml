# Modified Cilium configuration for Apple Container compatibility
# This configuration disables problematic IPv4 routing rules and uses
# simplified networking settings compatible with containerized environments

# Source: cilium/templates/cilium-secrets-namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: "cilium-secrets"
  labels:
    app.kubernetes.io/part-of: cilium
  annotations:
---
# Source: cilium/templates/cilium-agent/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: "cilium"
  namespace: kube-system
---
# Source: cilium/templates/cilium-operator/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: "cilium-operator"
  namespace: kube-system
---
# Source: cilium/templates/cilium-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cilium-config
  namespace: kube-system
data:
  # Apple Container Compatibility Settings

  # Use tunnel mode with VXLAN encapsulation - most compatible
  routing-mode: "tunnel"
  tunnel-protocol: "vxlan"

  # Disable IPv4 masquerading to avoid routing rule issues
  enable-ipv4-masquerade: "false"
  enable-ipv6-masquerade: "false"

  # Disable local node route management
  enable-local-node-route: "false"

  # Use simple datapath mode
  datapath-mode: "veth"

  # Disable advanced routing features that may require kernel capabilities
  enable-ipv4-big-tcp: "false"
  enable-ipv6-big-tcp: "false"
  enable-tcx: "false"

  # Disable features that may require iptables modifications
  enable-xt-socket-fallback: "false"
  enable-masquerade-to-route-source: "false"

  # Basic networking settings
  enable-ipv4: "true"
  enable-ipv6: "false"

  # Identity allocation using CRDs (no external kvstore needed)
  identity-allocation-mode: crd

  # Cluster mesh settings (disabled for single-node)
  cluster-name: default
  cluster-id: "0"

  # Disable L7 proxy to reduce complexity
  enable-l7-proxy: "false"

  # Service settings
  service-no-backend-response: "reject"

  # Monitor settings
  monitor-aggregation: maximum
  monitor-aggregation-interval: 5s
  monitor-aggregation-flags: all

  # Debug settings (can be enabled for troubleshooting)
  debug: "false"
  debug-verbose: ""

  # Disable Hubble for simplicity
  enable-hubble: "false"

  # Use default CIDR settings
  cluster-pool-ipv4-cidr: "10.0.0.0/8"
  cluster-pool-ipv4-mask-size: "24"
---
# Simplified Cilium DaemonSet with Apple Container compatibility
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cilium
  namespace: kube-system
  labels:
    k8s-app: cilium
spec:
  selector:
    matchLabels:
      k8s-app: cilium
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        k8s-app: cilium
    spec:
      hostNetwork: true
      serviceAccountName: cilium
      terminationGracePeriodSeconds: 1
      tolerations:
      - operator: Exists
      containers:
      - name: cilium-agent
        image: quay.io/cilium/cilium:v1.18.2
        imagePullPolicy: IfNotPresent
        command:
        - cilium-agent
        args:
        - --config-dir=/tmp/cilium/config-map
        startupProbe:
          httpGet:
            host: "127.0.0.1"
            path: /healthz
            port: 9879
            scheme: HTTP
            httpHeaders:
            - name: "brief"
              value: "true"
          failureThreshold: 105
          periodSeconds: 2
          successThreshold: 1
          timeoutSeconds: 5
        livenessProbe:
          httpGet:
            host: "127.0.0.1"
            path: /healthz
            port: 9879
            scheme: HTTP
            httpHeaders:
            - name: "brief"
              value: "true"
          periodSeconds: 30
          successThreshold: 1
          failureThreshold: 10
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            host: "127.0.0.1"
            path: /healthz
            port: 9879
            scheme: HTTP
            httpHeaders:
            - name: "brief"
              value: "true"
          periodSeconds: 30
          successThreshold: 1
          failureThreshold: 3
          timeoutSeconds: 5
        env:
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: CILIUM_K8S_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: KUBERNETES_SERVICE_HOST
          value: "kubernetes.default.svc.cluster.local"
        - name: KUBERNETES_SERVICE_PORT
          value: "443"
        lifecycle:
          preStop:
            exec:
              command:
              - /cni-uninstall.sh
        resources:
          limits:
            cpu: 4000m
            memory: 4Gi
          requests:
            cpu: 100m
            memory: 512Mi
        securityContext:
          seLinuxOptions:
            level: s0
            type: spc_t
          capabilities:
            add:
            - CHOWN
            - KILL
            - NET_ADMIN
            - NET_RAW
            - IPC_LOCK
            - SYS_MODULE
            - SYS_ADMIN
            - SYS_RESOURCE
            - DAC_OVERRIDE
            - FOWNER
            - SETGID
            - SETUID
            drop:
            - ALL
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        # To keep state between restarts / upgrades
        - name: cilium-run
          mountPath: /var/run/cilium
        # To keep state between restarts / upgrades for bpf maps
        - name: bpf-maps
          mountPath: /sys/fs/bpf
          mountPropagation: HostToContainer
        # To install cilium cni plugin in the host
        - name: cni-path
          mountPath: /host/opt/cni/bin
        # To install cilium cni configuration in the host
        - name: etc-cni-netd
          mountPath: /host/etc/cni/net.d
        # To be able to load kernel modules
        - name: lib-modules
          mountPath: /lib/modules
          readOnly: true
        # To access iptables concurrently with other processes (e.g. kube-proxy)
        - name: xtables-lock
          mountPath: /run/xtables.lock
        # To read the configuration from the config map
        - name: cilium-config-path
          mountPath: /tmp/cilium/config-map
          readOnly: true
        # To access the host's proc filesystem
        - name: proc
          mountPath: /host/proc
          readOnly: true
        # To access the host's sys filesystem
        - name: sys
          mountPath: /host/sys
          readOnly: true
        # To access the host's root filesystem for container runtime socket access
        - name: hostroot
          mountPath: /host
          readOnly: true
      initContainers:
      - name: install-cni-binaries
        image: quay.io/cilium/cilium:v1.18.2
        imagePullPolicy: IfNotPresent
        command:
        - "/install-plugin.sh"
        resources:
          requests:
            cpu: 100m
            memory: 10Mi
        securityContext:
          seLinuxOptions:
            level: s0
            type: spc_t
          capabilities:
            drop:
            - ALL
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - name: cni-path
          mountPath: /host/opt/cni/bin
      restartPolicy: Always
      priorityClassName: system-node-critical
      volumes:
      # To keep state between restarts / upgrades
      - name: cilium-run
        hostPath:
          path: /var/run/cilium
          type: DirectoryOrCreate
      # To keep state between restarts / upgrades for bpf maps
      - name: bpf-maps
        hostPath:
          path: /sys/fs/bpf
          type: DirectoryOrCreate
      # To install cilium cni plugin in the host
      - name: cni-path
        hostPath:
          path: /opt/cni/bin
          type: DirectoryOrCreate
      # To install cilium cni configuration in the host
      - name: etc-cni-netd
        hostPath:
          path: /etc/cni/net.d
          type: DirectoryOrCreate
      # To be able to load kernel modules
      - name: lib-modules
        hostPath:
          path: /lib/modules
      # To access iptables concurrently with other processes (e.g. kube-proxy)
      - name: xtables-lock
        hostPath:
          path: /run/xtables.lock
          type: FileOrCreate
      # To read the configuration from the config map
      - name: cilium-config-path
        configMap:
          name: cilium-config
      # To access the host's proc filesystem
      - name: proc
        hostPath:
          path: /proc
      # To access the host's sys filesystem
      - name: sys
        hostPath:
          path: /sys
      # To access the host's root filesystem for container runtime socket access
      - name: hostroot
        hostPath:
          path: /
---
# Cilium Operator Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cilium-operator
  namespace: kube-system
  labels:
    io.cilium/app: operator
    name: cilium-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      io.cilium/app: operator
      name: cilium-operator
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 50%
    type: RollingUpdate
  template:
    metadata:
      labels:
        io.cilium/app: operator
        name: cilium-operator
    spec:
      containers:
      - name: cilium-operator
        image: quay.io/cilium/operator-generic:v1.18.2
        imagePullPolicy: IfNotPresent
        command:
        - cilium-operator-generic
        args:
        - --config-dir=/tmp/cilium/config-map
        - --debug=$(CILIUM_DEBUG)
        env:
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: CILIUM_K8S_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: CILIUM_DEBUG
          valueFrom:
            configMapKeyRef:
              key: debug
              name: cilium-config
              optional: true
        livenessProbe:
          httpGet:
            host: "127.0.0.1"
            path: /healthz
            port: 9234
            scheme: HTTP
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 3
        readinessProbe:
          httpGet:
            host: "127.0.0.1"
            path: /healthz
            port: 9234
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 3
        volumeMounts:
        - name: cilium-config-path
          mountPath: /tmp/cilium/config-map
          readOnly: true
        terminationMessagePolicy: FallbackToLogsOnError
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 128Mi
      serviceAccountName: cilium-operator
      volumes:
      - name: cilium-config-path
        configMap:
          name: cilium-config
      tolerations:
      - operator: Exists
---
# Required ClusterRole for Cilium
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cilium
rules:
- apiGroups:
  - networking.k8s.io
  resources:
  - networkpolicies
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - discovery.k8s.io
  resources:
  - endpointslices
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - namespaces
  - services
  - pods
  - endpoints
  - nodes
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - cilium.io
  resources:
  - ciliumidentities
  - ciliumendpoints
  - ciliumnodes
  - ciliumnetworkpolicies
  - ciliumclusterwidenetworkpolicies
  verbs:
  - '*'
---
# ClusterRole for Cilium Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cilium-operator
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
  - delete
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - services
  - endpoints
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - cilium.io
  resources:
  - ciliumnetworkpolicies
  - ciliumclusterwidenetworkpolicies
  verbs:
  - create
  - update
  - deletecollection
  - patch
  - get
  - list
  - watch
- apiGroups:
  - cilium.io
  resources:
  - ciliumidentities
  verbs:
  - create
  - update
  - delete
  - get
  - list
  - watch
- apiGroups:
  - cilium.io
  resources:
  - ciliumnodes
  verbs:
  - create
  - update
  - get
  - list
  - watch
- apiGroups:
  - cilium.io
  resources:
  - ciliumendpoints
  verbs:
  - get
  - list
  - watch
---
# ClusterRoleBinding for Cilium
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cilium
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cilium
subjects:
- kind: ServiceAccount
  name: cilium
  namespace: kube-system
---
# ClusterRoleBinding for Cilium Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cilium-operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cilium-operator
subjects:
- kind: ServiceAccount
  name: cilium-operator
  namespace: kube-system