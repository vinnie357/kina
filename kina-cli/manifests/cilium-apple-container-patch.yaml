---
# Cilium ConfigMap patch for Apple Container compatibility
apiVersion: v1
kind: ConfigMap
metadata:
  name: cilium-config
  namespace: kube-system
data:
  # Disable features that require full kernel support
  enable-bpf-masquerade: "false"
  enable-ipsec: "false"
  enable-wireguard: "false"

  # Use alternative datapath mode
  datapath-mode: "netns"

  # Disable transparent proxy and socket-based features
  bpf-lb-sock: "false"
  enable-xt-socket-fallback: "false"

  # Disable features requiring /proc/schedstat
  enable-bpf-clock-probe: "false"

  # Use simpler routing
  routing-mode: "native"
  auto-direct-node-routes: "true"

  # Disable advanced eBPF features that may not work
  enable-bandwidth-manager: "false"
  enable-host-firewall: "false"
  enable-endpoint-routes: "true"

  # Fallback to iptables for missing kernel modules
  install-iptables-rules: "true"

  # Disable problematic BPF maps
  bpf-events-drop-enabled: "false"
  bpf-events-policy-verdict-enabled: "false"
  bpf-events-trace-enabled: "false"

  # Container-friendly settings
  enable-local-node-route: "false"
  enable-health-check-nodeport: "false"

  # Debug settings for troubleshooting
  debug: "true"
  debug-verbose: "datapath"